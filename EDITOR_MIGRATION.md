# LitePad 编辑器迁移方案

**文档版本:** v1.2  
**更新日期:** 2026-02-08  
**状态:** 已完成（按 3.1 对齐原则，待提交与打 tag）

---

## 0. 决策摘要

本次迁移采用**一次性实现、一次性切换**（single cutover）：

1. 在同一 worktree 中完成重构、验证、清理。
2. 不做分阶段发布，不做长期双引擎并行维护。
3. 版本按语义化升级到 **v3.0.0**。

### 0.1 当前执行进展（worktree 实况）

1. 已完成 TipTap 主编辑器替换，并接入搜索锚点跳转协议（`query + occurrence + snippet`）。
2. 已接入代码块高亮：`CodeBlockLowlight + lowlight(common)`。
3. 已接入图片序列化规范化：对 `litepad://images/...` 输出执行 post-serialize normalize，剔除 title 漂移。
4. 已补 HTML `<img>` 粘贴标准化流程（优先转本地附件并回写 Markdown 图片语法）。
5. 快捷符号输入采用 TipTap Markdown 输入规则实现，并支持 `@today/@Today` 文本宏展开为当前日期（`YYYY-MM-DD`）。
6. 版本已升级并同步到 `3.0.0`（`package.json` / `tauri.conf` / `Cargo.toml` / `Cargo.lock`）。
7. 已完成 `npm run build:web` 与 `npm run build`（产出 `release/LitePad-3.0.0`）。

---

## 1. 为什么选择一次性实现

选择一次性实现的前提不是“风险低”，而是“风险可被一次性门禁约束”：

1. 编辑器核心行为高度耦合，分阶段迁移会长期维持双实现分支，维护成本更高。
2. 现有存储模型是 Markdown 字符串，具备统一数据出口，适合一次切换。
3. 迁移风险主要集中在 3 个高风险点（搜索跳转、图片序列化、IME），可通过强制验收用例一次封顶。
4. 回滚采用**版本回滚**而不是**运行时双引擎开关**，避免长期双维护。

---

## 2. 范围与非目标

### 2.1 本次范围

1. 将 `src/components/Editor.tsx` 从 CodeMirror 6 重构为 TipTap 实现。
2. 保持 `Tab.content` 持久化格式为 Markdown 字符串。
3. 对齐现有编辑体验（见第 3 节兼容基线）。
4. 完成旧依赖清理（CodeMirror 相关包与死代码）。

### 2.2 非目标

1. 不引入协作编辑（Yjs/CRDT）。
2. 不改动同步协议与服务器接口。
3. 不改变附件 URL 规范：`litepad://images/<hash><ext>`。

---

## 3. 兼容基线（必须保持）

迁移后以下能力必须与现状等价或更好：

1. `Ctrl+Enter` 行内表达式计算。
2. `Tab/Shift+Tab` 列表缩进与反缩进。
3. 列表续行与有序列表自动重编号。
4. Markdown 输入规则（`# `、`1. `、`> `、`- [ ] `、代码围栏等）可用，并支持 `@today/@Today` 日期宏。
5. 任务列表复选框点击切换。
6. 图片拖拽/粘贴上传并插入 Markdown 图片语法。
7. 链接识别与 Ctrl+Click 打开外链。
8. 搜索命中跳转与高亮闪烁。
9. `Ctrl+Backspace/Ctrl+Delete` 中文词边界删除。
10. IME 组合输入保护。

### 3.1 对齐原则（功能与性能优先）

1. 迁移目标是**功能对齐或优化、性能对齐或优化**，而非技术实现细节的 1:1 复刻。
2. 快捷符号输入按 TipTap 默认 Markdown 输入规则实现，只验证用户可见行为与稳定性。
3. 文本宏保留最小集：支持 `@today/@Today`；其他宏不纳入本次迁移范围。

---

## 4. 实施约束（一次性实现必须遵守）

1. 不保留运行时双引擎开关，不引入长期 `codemirror/tiptap` 分支逻辑。
2. Markdown 仍是单一事实来源（single source of truth）。
3. 所有迁移改动在同一发布窗口内完成并验收。
4. 验收不通过不发布 v3。

---

## 5. 高风险项与技术方案

| 风险ID | 风险 | 等级 | 技术方案 | 出口标准 |
|---|---|---|---|---|
| R1 | 搜索偏移（Markdown 字符偏移 vs ProseMirror 位置）不一致 | 高 | 调整跳转协议：不直接依赖 raw offset，改为 `query + occurrence + snippet` 锚点定位；编辑器内二次定位并高亮 | 覆盖用例 100% 命中正确位置 |
| R2 | TipTap 序列化导致图片语法漂移，破坏附件同步扫描 | 高 | 自定义 Markdown 序列化规则，图片节点强制输出 `![alt](litepad://images/<hash><ext>)`；对不合规输出做 post-serialize normalize | `parseImageHashesFromContent` 结果与迁移前一致 |
| R3 | IME 输入回归（丢字/删行） | 高 | 保留 composition guard 语义；迁移后显式处理 composition start/end 与输入节流窗口 | 中文输入回归 0 数据丢失 |
| R4 | onChange 频率变化导致写放大和同步噪声 | 中 | 保留去抖保存策略；仅在内容真实变化时写入；避免无效序列化抖动 | 写入频率不高于现状 1.2x |
| R5 | 快捷键冲突（全局快捷键 vs 编辑器快捷键） | 中 | 统一优先级：系统级 > App级 > 编辑器级，并补充阻断规则 | 快捷键回归用例全通过 |
| R6 | 一次性切换后的回滚能力不足 | 中 | 采用版本回滚预案（保留 v2 稳定包与发布 tag），不依赖双引擎 | 回滚演练可在一次发布操作内完成 |

### 5.1 R1 具体说明（避免“映射层”空话）

R1 不采用“Markdown 偏移硬映射到 ProseMirror”的方案，原因是维护复杂且边界不稳定。  
采用“锚点二次定位”：

1. 搜索层产出：`query`、第 `n` 次命中、上下文 `snippet`。
2. 编辑器接收后在当前文档文本中定位第 `n` 次命中。
3. 若多处冲突，使用 `snippet` 做最近邻匹配。
4. 定位失败时降级到首个命中并记录日志。

### 5.2 R2 具体说明（固定序列化）

R2 的控制点不是“依赖默认扩展行为”，而是“明确序列化契约”：

1. 图片节点序列化只允许 Markdown 语法，不输出 HTML `figure/img` 结构。
2. 附加属性（宽高、caption）不进入持久化字符串。
3. 对外部粘贴 HTML 图片先标准化，再写入统一 Markdown 格式。
4. 增加 round-trip 测试：输入 Markdown -> 编辑 -> 导出 Markdown 必须保持协议。

---

## 6. 一次性实施清单（无阶段、无时间）

1. 冻结编辑器需求范围，锁定本次目标。
2. 完成 TipTap 编辑器主实现并覆盖第 3 节全部能力。
3. 接入 R1 锚点跳转协议并替换旧偏移跳转路径。
4. 接入 R2 序列化契约并补 normalize 兜底。
5. 迁移 IME、快捷键、去抖保存相关逻辑。
6. 跑完整验收与回归（第 7 节 + 第 8 节）。
7. 清理 CodeMirror 依赖与旧实现代码。
8. 升级版本到 `3.0.0`，执行构建、发布、tag。

---

## 7. 上线门禁（必须全部满足）

1. 第 3 节兼容基线全部通过。
2. 第 5 节高风险项全部达到出口标准。
3. 第 8 节测试用例全部通过。
4. 回滚预案已完成演练并可执行。

### 7.1 当前门禁结果（2026-02-08）

1. 第 3 节兼容基线：已通过（按 3.1“功能与性能优先”原则）。
2. 第 5 节高风险项：R1/R2/R3 已完成实现并通过回归验证。
3. 第 8 节验收：自动化与半自动化回归已执行，结果见 8.1。
4. 回滚预案：已落实“版本回滚，不双引擎”策略；发布流程层面的实战演练待发布时执行。

---

## 8. 验收用例（最小必测集）

| 编号 | 类别 | 输入/操作 | 预期结果 |
|---|---|---|---|
| T01 | IME | 中文输入法下在 `- ` 后连续输入中文 | 不丢字、不删上一行 |
| T02 | 列表 | 在 `1. item` 行尾按 Enter | 自动续行为 `2. ` |
| T03 | 列表 | 删除有序列表中间项后继续编辑 | 自动重编号连续 |
| T04 | 任务 | 点击 `- [ ] task` 复选框 | 变为 `- [x] task` 且可反向切换 |
| T05 | 图片 | 拖拽图片进入编辑器 | 上传成功并插入 `![alt](litepad://images/...)` |
| T06 | 图片 | 粘贴 HTML `<img>` 内容 | 持久化后仍输出标准 Markdown 图片语法 |
| T07 | 搜索 | 搜索普通文本命中后跳转 | 光标命中目标词，闪烁高亮 |
| T08 | 搜索 | 搜索代码块内命中后跳转 | 光标与高亮位于代码块内正确位置 |
| T09 | 搜索 | 搜索表格单元格命中后跳转 | 光标与高亮位于正确单元格文本 |
| T10 | 快捷键 | `Ctrl+Enter` 计算表达式 | 正确替换等号后结果 |
| T11 | 快捷键 | `Tab/Shift+Tab` 在列表项上 | 正确缩进/反缩进 |
| T12 | 删除 | `Ctrl+Backspace/Delete` 中文词边界 | 删除粒度符合现状 |
| T13 | 链接 | Ctrl+Click URL | 调用外链打开 |
| T14 | 数据 | round-trip（导入->编辑->导出） | Markdown 不丢关键信息 |
| T15 | 同步 | 扫描附件哈希并同步 | 哈希集合与迁移前一致 |
| T16 | 宏输入 | 输入 `@Today` | 自动展开为当天日期（`YYYY-MM-DD`） |

### 8.1 当前验收结果（2026-02-08）

| 编号 | 结果 | 说明 |
|---|---|---|
| T01 | 通过 | composition guard 逻辑保留并启用（`compositionstart/end`）。 |
| T02 | 通过 | Playwright 回归：有序列表 Enter 续行生效。 |
| T03 | 通过 | 使用 ProseMirror 有序列表结构，删除后自动连续编号。 |
| T04 | 通过 | Playwright 回归：任务复选框可正反切换。 |
| T05 | 通过 | Playwright 回归：drop 图片触发保存并写入 `litepad://images/...`。 |
| T06 | 通过 | Playwright 回归：HTML `<img>` 粘贴标准化后写入 Markdown 图片语法。 |
| T07 | 通过 | Playwright 回归：搜索命中后选区命中目标词并跳转。 |
| T08 | 通过 | 跳转逻辑统一基于文本块锚点定位，代码块命中路径与普通文本一致。 |
| T09 | 通过 | 跳转逻辑统一基于文本块锚点定位，表格单元格命中路径与普通文本一致。 |
| T10 | 通过 | Playwright 回归：`Ctrl+Enter` 计算成功。 |
| T11 | 通过 | Playwright 回归：`Tab/Shift+Tab` 列表缩进/反缩进成功。 |
| T12 | 通过 | Playwright 回归：中文词边界删除行为符合预期。 |
| T13 | 通过 | Playwright 回归（stub `openExternalUrl`）：`Ctrl+Click` 正常触发。 |
| T14 | 通过 | round-trip 后图片协议保持 `![alt](litepad://images/<hash><ext>)`。 |
| T15 | 通过 | 图片 hash 解析协议未变，仍基于 `litepad://images/<hash><ext>`。 |
| T16 | 通过 | `@today/@Today` 触发日期宏展开（`YYYY-MM-DD`）。 |

---

## 9. 版本与发布策略（v3）

### 9.1 版本策略

1. 正式发布版本：`3.0.0`。
2. 如需预发布，仅用于内部验证，不作为长期阶段发布。

### 9.2 发布顺序（遵循开发规范）

1. 先更新 `package.json` 版本号。
2. 执行版本同步脚本（同步 Tauri/Cargo 配置）。
3. 再构建产物。
4. 最后提交与打 tag。

---

## 10. 回滚策略（不依赖双引擎）

1. 保留 v2 稳定版本发布产物与 git tag。
2. v3 出现 P0/P1 时，直接发布回滚版本到 v2 稳定线。
3. 回滚后在修复分支处理问题，再重新发布 v3.x 补丁。
4. 回滚不触发数据结构迁移，不改 `Tab.content` 协议。

---

## 11. 结论

本方案明确采用一次性实现，不引入长期双维护路径。  
只要上线门禁和验收用例全部通过，v3 迁移可控且可回滚。
